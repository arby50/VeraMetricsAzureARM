{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"metadata": {
		"_generator": {
			"name": "bicep",
			"version": "0.34.1.11899",
			"templateHash": "6608977399677963554"
		}
	},
	"parameters": {
        "vmInstanceName": {
            "type": "string",
            "metadata": {
                "description": "The VM name"
            }
        },
        "vmSize": {
            "type": "string",
            "metadata": {
                "description": "Select the VM size"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Select the Azure region for the resources"
            }
        },
		"adminUsername": {
			"type": "string",
			"defaultValue": "jwdillonAdmin",
			"metadata": {
			"description": "Admin username for the VM"
			}
		}
	},
	"variables": {
		"adminUsername": "[parameters('adminUsername')]",
		"planInfo": {
            "planID": "verametrics_engine_vm_plan",
            "offerID": "verametrics_engine",
            "publisher": "jwdillon_com"
        },
		"networkSecurityGroupName": "[format('{0}-nsg', parameters('vmInstanceName'))]",
		"publicIPAddressName": "[format('{0}-pip', toLower(parameters('vmInstanceName')))]",
		"networkInterfaceName": "[format('{0}-nic', parameters('vmInstanceName'))]",
		"virtualNetworkName": "[format('{0}-vnet', parameters('vmInstanceName'))]",
		"subnetName": "[format('{0}-subnet', parameters('vmInstanceName'))]",
		"vmName": "[format('{0}-vm', parameters('vmInstanceName'))]",
		"subnetAddressPrefix": "10.1.0.0/24",
		"addressPrefix": "10.1.0.0/16",
		"securityType": "Standard",
		"osDiskType": "Standard_LRS",
		"securityProfileJson": {
			"uefiSettings": {
				"secureBootEnabled": true,
				"vTpmEnabled": true
			},
			"securityType": "[variables('securityType')]"
		},
		"extensionName": "GuestAttestation",
		"extensionPublisher": "Microsoft.Azure.Security.LinuxAttestation",
		"extensionVersion": "1.0",
		"maaTenantName": "GuestAttestation",
		"maaEndpoint": "[substring('emptystring', 0, 0)]"
	},
	"resources": [
		{
			"type": "Microsoft.Network/networkInterfaces",
			"apiVersion": "2023-09-01",
			"name": "[variables('networkInterfaceName')]",
			"location": "[parameters('location')]",
			"properties": {
				"ipConfigurations": [
					{
						"name": "ipconfig1",
						"properties": {
							"subnet": {
								"id": "[reference(resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName')), '2023-09-01').subnets[0].id]"
							},
							"privateIPAllocationMethod": "Dynamic",
							"publicIPAddress": {
								"id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressName'))]"
							}
						}
					}
				],
				"networkSecurityGroup": {
					"id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]"
				}
			},
			"dependsOn": [
				"[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]",
				"[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressName'))]",
				"[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]"
			]
		},
		{
			"type": "Microsoft.Network/networkSecurityGroups",
			"apiVersion": "2024-05-01",
			"name": "[variables('networkSecurityGroupName')]",
			"location": "[parameters('location')]",
			"properties": {
				"securityRules": [
					{
						"name": "AllowFlaskInbound",
						"properties": {
							"priority": 101,
							"direction": "Inbound",
							"access": "Allow",
							"protocol": "Tcp",
							"sourcePortRange": "*",
							"destinationPortRange": "443",
							"sourceAddressPrefix": "Internet",
							"destinationAddressPrefix": "*"
						}
					},
					{
						"name": "DenyRDPInboundFromInternet",
						"properties": {
							"priority": 1000,
							"direction": "Inbound",
							"access": "Deny",
							"protocol": "Tcp",
							"sourcePortRange": "*",
							"destinationPortRange": "3389",
							"sourceAddressPrefix": "Internet",
							"destinationAddressPrefix": "*"
						}
					},
					{
						"name": "DenySSHInboundFromInternet",
						"properties": {
							"priority": 1001,
							"direction": "Inbound",
							"access": "Deny",
							"protocol": "Tcp",
							"sourcePortRange": "*",
							"destinationPortRange": "22",
							"sourceAddressPrefix": "Internet",
							"destinationAddressPrefix": "*"
						}
					}
				]
			}
		},
		{
			"type": "Microsoft.Network/virtualNetworks",
			"apiVersion": "2023-09-01",
			"name": "[variables('virtualNetworkName')]",
			"location": "[parameters('location')]",
			"properties": {
				"addressSpace": {
					"addressPrefixes": [
						"[variables('addressPrefix')]"
					]
				},
				"subnets": [
					{
						"name": "[variables('subnetName')]",
						"properties": {
							"networkSecurityGroup": {
								"id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]"
							},
							"addressPrefix": "[variables('subnetAddressPrefix')]",
							"privateEndpointNetworkPolicies": "Enabled",
							"privateLinkServiceNetworkPolicies": "Enabled"
						}
					}
				]
			},
			"dependsOn": [
				"[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]"
			]
		},
		{
			"type": "Microsoft.Network/publicIPAddresses",
			"apiVersion": "2023-09-01",
			"name": "[variables('publicIPAddressName')]",
			"location": "[parameters('location')]",
			"sku": {
				"name": "Standard"
			},
			"properties": {
				"publicIPAllocationMethod": "Static",
				"publicIPAddressVersion": "IPv4",
				"dnsSettings": {
					"domainNameLabel": "[variables('publicIPAddressName')]"
				},
				"idleTimeoutInMinutes": 4
			}
		},
		{
			"type": "Microsoft.Compute/virtualMachines",
			"apiVersion": "2023-09-01",
			"name": "[variables('vmName')]",
			"location": "[parameters('location')]",
			"plan": {
                "name": "[variables('planInfo').planID]",
                "product": "[variables('planInfo').offerID]",
                "publisher": "[variables('planInfo').publisher]"
            },
			"properties": {
				"hardwareProfile": {
					"vmSize": "[parameters('vmSize')]"
				},
                "storageProfile": {
                    "imageReference": {
                        "offer": "[variables('planInfo').offerID]",
                        "publisher": "[variables('planInfo').publisher]",
                        "sku": "[variables('planInfo').planID]",
                        "version": "latest"
                    },
                    "osdisk": {
                        "name": "[concat(variables('vmName'), '-osDisk')]",
                        "createOption": "FromImage",
                        "managedDisk": {
                           	"storageAccountType": "[variables('osDiskType')]"
                        },
                        "caching": "ReadWrite"
                    }
                },
				"osProfile": {
					"computerName": "[variables('vmName')]",
					"adminUsername": "[variables('adminUsername')]",
					"linuxConfiguration": {
						"disablePasswordAuthentication": true,
						"ssh": {
							"publicKeys": [
								{
									"path": "[format('/home/{0}/.ssh/authorized_keys', variables('adminUsername'))]",
									"keyData": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7laRyN4B3YZmVrDEZLZoIuDep9OtVwikHFQMmkjdgBsOI9P6j3CJEw7W9Z3QtR5N8JkZKwVQRHE5LlO9XP6w5Y4yF4i4X2z7qKJGNjHr2mY+9YRt4L6yOyQa6Zl7F placeholder-key-replaced-by-script"
								}
							]
						}
					}
				},
				"networkProfile": {
					"networkInterfaces": [
						{
							"id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName'))]"
						}
					]
				},
				"securityProfile": "[if(equals(variables('securityType'), 'TrustedLaunch'), variables('securityProfileJson'), null())]"
			},
			"dependsOn": [
				"[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName'))]"
			]
		},
		
		{
			"type": "Microsoft.Compute/virtualMachines/extensions",
			"apiVersion": "2023-09-01",
			"name": "[format('{0}/{1}', variables('vmName'), 'SSHSetupScript')]",
			"location": "[parameters('location')]",
			"properties": {
				"publisher": "Microsoft.Azure.Extensions",
				"type": "CustomScript",
				"typeHandlerVersion": "2.1",
				"autoUpgradeMinorVersion": true,
				"settings": {
					"commandToExecute": "[concat('bash -c \"', base64ToString('CiMhL2Jpbi9iYXNoCgojIHRoaXMgc2NyaXB0IGlzIHVzZWQgdG8gc2V0dXAgdGhlIHNzaCBhY2Nlc3MgZm9yIHRoZSBhZG1pbiB1c2VyCiMgaXQgaXMgcnVuIGluc2lkZSB0aGUgbWFpblRlbXBsYXRlLmpzb24gZmlsZSwgYmFzZTY0IGVuY29kZWQKIyBtaWNyb3NvZnQgcmVxdWlyZXMgc3NoIHVpZDpwd2QgYXV0aCB0byBiZSBlbmFibGVkIHdoZW4gY3JlYXRpZyBmcm9tIGEgdGVtcGxhdGUKIyB0aGlzIHNjcmlwdCBkaXNhYmxlcyBpdCBhbmQgc2V0cyB1cCBzc2gga2V5IGF1dGgKIyBpdCBhbHNvIGNoYW5nZXMgdGhlIG93bmVyc2hpcCBvZiB0aGUgZmxhc2sgYXBwIHRvIHRoZSBhZG1pbiB1c2VyCiMgYW5kIHJlc3RhcnRzIHRoZSBzc2ggc2VydmljZQojIGl0IGlzIHJ1biBhcyBhIGN1c3RvbSBzY3JpcHQgZXh0ZW5zaW9uIG9uIHRoZSB2bQojIGl0IGNvcGVzIHRoZSBzc2gga2V5IGZyb20gYSBzYWZlIGxvY2F0aW9uICgvdXNyL2xvY2FsL3N1cHBvcnQvKSB0byB0aGUgYWRtaW4gdXNlcidzIC5zc2ggZGlyZWN0b3J5CgojIFBhcnNlIHBhcmFtZXRlcnMKUkVTT1VSQ0VfSUQ9IiQxIgpNQVJLRVRQTEFDRV9TVUJTQ1JJUFRJT05fSUQ9IiQyIgoKaWYgWyAteiAiJFJFU09VUkNFX0lEIiBdOyB0aGVuCiAgICBlY2hvICJFcnJvcjogUmVzb3VyY2UgSUQgbm90IHByb3ZpZGVkIgogICAgZXhpdCAxCmZpCgojIENyZWF0ZSBhZG1pbiB1c2VyCnVzZXJhZGQgLW0gLXMgL2Jpbi9iYXNoIGp3ZGlsbG9uQWRtaW4KCiMgQ3JlYXRlIC5zc2ggZGlyZWN0b3J5Cm1rZGlyIC1wIC9ob21lL2p3ZGlsbG9uQWRtaW4vLnNzaApjaG1vZCA3MDAgL2hvbWUvandkaWxsb25BZG1pbi8uc3NoCgojIENvcHkgcHJlLXBsYWNlZCBTU0gga2V5IGZyb20gc2FmZSBsb2NhdGlvbgppZiBbIC1mIC91c3IvbG9jYWwvc3VwcG9ydC9hdXRob3JpemVkX2tleXMgXTsgdGhlbgogICAgY3AgL3Vzci9sb2NhbC9zdXBwb3J0L2F1dGhvcml6ZWRfa2V5cyAvaG9tZS9qd2RpbGxvbkFkbWluLy5zc2gvYXV0aG9yaXplZF9rZXlzCiAgICBlY2hvICJTU0gga2V5IGNvcGllZCBmcm9tIHByZS1wbGFjZWQgbG9jYXRpb24iCmVsc2UKICAgIGVjaG8gIk5vIHByZS1wbGFjZWQgU1NIIGtleSBmb3VuZCBhdCAvdXNyL2xvY2FsL3N1cHBvcnQvYXV0aG9yaXplZF9rZXlzIgpmaQoKIyBTZXQgY29ycmVjdCBwZXJtaXNzaW9ucwpjaG1vZCA2MDAgL2hvbWUvandkaWxsb25BZG1pbi8uc3NoL2F1dGhvcml6ZWRfa2V5cwpjaG93biAtUiBqd2RpbGxvbkFkbWluOmp3ZGlsbG9uQWRtaW4gL2hvbWUvandkaWxsb25BZG1pbi8uc3NoCgojIENoYW5nZSBvd25lcnNoaXAgb2YgRmxhc2sgYXBwIHRvIGp3ZGlsbG9uQWRtaW4KY2hvd24gLVIgandkaWxsb25BZG1pbjpqd2RpbGxvbkFkbWluIC92YXIvd3d3L2h0bWwvCmNob3duIC1SIGp3ZGlsbG9uQWRtaW46andkaWxsb25BZG1pbiAvb3B0L3NwYXJrLwoKIyBFbnN1cmUgU1NIIGNvbmZpZyBhbGxvd3Mga2V5IGF1dGhlbnRpY2F0aW9uIG9ubHkKc2VkIC1pICdzLyNQdWJLZXlBdXRoZW50aWNhdGlvbiB5ZXMvUHVia2V5QXV0aGVudGljYXRpb24geWVzL2cnIC9ldGMvc3NoL3NzaGRfY29uZmlnCnNlZCAtaSAncy9QdWJLZXlBdXRoZW50aWNhdGlvbiBuby9QdWJrZXlBdXRoZW50aWNhdGlvbiB5ZXMvZycgL2V0Yy9zc2gvc3NoZF9jb25maWcKCiMgUmVzdGFydCBTU0ggc2VydmljZQpzeXN0ZW1jdGwgcmVzdGFydCBzc2gKCiMgQ3JlYXRlIGVudmlyb25tZW50IGZpbGUgZm9yIHRoZSBhcHBsaWNhdGlvbgojIG1rZGlyIC1wIC9vcHQvdmVyYW1ldHJpY3MKY2F0ID4gL2hvbWUvandkaWxsb25BZG1pbi8uZW52IDw8IEVPRgpBWlVSRV9SRVNPVVJDRV9JRD0ke1JFU09VUkNFX0lEfQpNQVJLRVRQTEFDRV9TVUJTQ1JJUFRJT05fSUQ9JHtNQVJLRVRQTEFDRV9TVUJTQ1JJUFRJT05fSUR9CkVPRgoKIyBTZXQgb3duZXJzaGlwIG9mIHRoZSBlbnZpcm9ubWVudCBmaWxlCmNob3duIGp3ZGlsbG9uQWRtaW46andkaWxsb25BZG1pbiAvaG9tZS9qd2RpbGxvbkFkbWluLy5lbnYKY2htb2QgNjAwIC9ob21lL2p3ZGlsbG9uQWRtaW4vLmVudgoKZWNobyAiU1NIIGFjY2VzcyBzZXR1cCBjb21wbGV0ZSBmb3IgandkaWxsb25BZG1pbiIKZWNobyAiVk0gY29uZmlndXJlZCB3aXRoIFJlc291cmNlIElEOiAkUkVTT1VSQ0VfSUQi'), '\" \"', resourceGroup().id, '\" \"', subscription().id, '\"')]"
				}
			},
			"dependsOn": [
				"[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
			]
		}
	],
	"outputs": {
		"hostname": {
			"type": "string",
			"value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressName')), '2023-09-01').dnsSettings.fqdn]"
		}
	}
}